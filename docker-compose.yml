# Docker Compose para Migro Hiring Frontend

services:
  # ==========================================
  # Servicio de Desarrollo (Vite + Hot Reload)
  # ==========================================
  dev:
    container_name: migro-hiring-dev
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3000/api}
      - VITE_STRIPE_PUBLISHABLE_KEY=${VITE_STRIPE_PUBLISHABLE_KEY:-pk_test_placeholder}
      - VITE_APP_URL=${VITE_APP_URL:-http://localhost:5173}
      - VITE_SHORT_URL_BASE=${VITE_SHORT_URL_BASE:-http://localhost:5173}
      - VITE_PUBLIC_DOMAIN=${VITE_PUBLIC_DOMAIN:-localhost:5173}
      - VITE_PILI_API_URL=${VITE_PILI_API_URL:-http://localhost:8001/api}
      - VITE_DEBUG_MODE=${VITE_DEBUG_MODE:-true}
      - VITE_API_TIMEOUT=${VITE_API_TIMEOUT:-30000}
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    ports:
      - "5173:5173"
    networks:
      - migro-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ==========================================
  # Servicio de Producción (nginx)
  # ==========================================
  prod:
    container_name: migro-hiring-prod
    build:
      context: .
      dockerfile: Dockerfile
      # El Dockerfile solo tiene 2 stages: deps, builder, y runner (nginx)
      # Docker usa el último por defecto (runner)
      args:
        # Usar DOCKER_API_BASE_URL si existe, sino convertir localhost de VITE_API_BASE_URL
        - VITE_API_BASE_URL=${DOCKER_API_BASE_URL:-${VITE_API_BASE_URL}}
        # Valores por defecto solo para desarrollo local (localhost)
        # En producción, estas variables DEBEN estar definidas o el build fallará
        # NOTA: VITE_STRIPE_PUBLISHABLE_KEY usa pk_test_placeholder como fallback solo para desarrollo
        # En producción, DEBE estar definida con una clave real
        - VITE_STRIPE_PUBLISHABLE_KEY=${VITE_STRIPE_PUBLISHABLE_KEY:-pk_test_placeholder}
        - VITE_APP_URL=${VITE_APP_URL:-http://localhost:5173}
        - VITE_SHORT_URL_BASE=${VITE_SHORT_URL_BASE:-http://localhost:5173}
        - VITE_PUBLIC_DOMAIN=${VITE_PUBLIC_DOMAIN:-localhost:5173}
        # IMPORTANTE: VITE_PILI_API_URL se usa en el navegador, no dentro del contenedor
        # Por lo tanto, NO debe usar DOCKER_PILI_API_URL (que sería host.docker.internal)
        # El navegador necesita usar localhost:8001 que está mapeado desde el host
        - VITE_PILI_API_URL=${VITE_PILI_API_URL:-http://localhost:8001/api}
        - VITE_DEBUG_MODE=${VITE_DEBUG_MODE:-false}
        - VITE_API_TIMEOUT=${VITE_API_TIMEOUT:-30000}
    environment:
      # Pasar VITE_API_BASE_URL al contenedor para el CSP de nginx
      - VITE_API_BASE_URL=${DOCKER_API_BASE_URL:-${VITE_API_BASE_URL}}
      # Configurar PORT para que nginx escuche en el puerto correcto
      - PORT=80
    extra_hosts:
      # Mapear host.docker.internal a la IP del host para compatibilidad
      - "host.docker.internal:host-gateway"
    ports:
      - "80:80"
    networks:
      - migro-network
    restart: unless-stopped
    profiles:
      - production

  # ==========================================
  # Servicio adicional: Mock API (opcional para desarrollo)
  # ==========================================
  mock-api:
    image: stoplight/prism:latest
    container_name: migro-hiring-mock-api
    command: mock -h 0.0.0.0 /openapi.yml
    ports:
      - "8000:4010"
    volumes:
      - ./docker/openapi.yml:/openapi.yml:ro
    networks:
      - migro-network
    profiles:
      - mock
    restart: unless-stopped

networks:
  migro-network:
    driver: bridge

volumes:
  node_modules:

